<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{qrmanage/shop/layout/qr-manage-shop-layout}">

<th:block layout:fragment="content">
    <div class="qr-manage-page-header">
        <h1 class="qr-manage-page-title">카테고리 관리</h1>
        <a th:href="@{/qr-manage/shop/admin/category/new}" class="qr-manage-btn qr-manage-btn-primary">카테고리 추가</a>
    </div>

    <!-- 알림 메시지 -->
    <div th:if="${message}" class="qr-manage-alert qr-manage-alert-success" th:text="${message}"></div>
    <div th:if="${error}" class="qr-manage-alert qr-manage-alert-danger" th:text="${error}"></div>

    <!-- 카테고리 목록 -->
    <div class="qr-manage-card">
        <div class="qr-manage-card-header">
            <h2 class="qr-manage-card-title">
                카테고리 목록 <span style="font-weight: normal; color: #999;">(총 <span th:text="${#lists.size(categories)}">0</span>개)</span>
            </h2>
        </div>
        <div class="qr-manage-card-body">
            <table class="qr-manage-table" th:if="${!#lists.isEmpty(categories)}" id="categoryTable">
                <thead>
                    <tr>
                        <th style="width: 50px;">순서</th>
                        <th>카테고리명</th>
                        <th>설명</th>
                        <th>메뉴 수</th>
                        <th>공개</th>
                        <th>관리</th>
                    </tr>
                </thead>
                <tbody id="sortableCategories">
                    <tr th:each="category : ${categories}" th:data-id="${category.id}">
                        <td class="qr-manage-drag-handle" style="cursor: move; text-align: center;">☰</td>
                        <td th:text="${category.name}">카테고리명</td>
                        <td th:text="${category.description ?: '-'}">설명</td>
                        <td th:text="${category.menuCount ?: 0}">0</td>
                        <td>
                            <form th:action="@{/qr-manage/shop/admin/category/visibility/{id}(id=${category.id})}" method="post" style="display: inline;">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                <input type="hidden" name="isVisible" th:value="${!category.isVisible}"/>
                                <button type="submit" class="qr-manage-badge"
                                        th:classappend="${category.isVisible ? 'qr-manage-badge-active' : 'qr-manage-badge-suspended'}"
                                        th:text="${category.isVisible ? '공개' : '비공개'}">공개</button>
                            </form>
                        </td>
                        <td>
                            <a th:href="@{/qr-manage/shop/admin/category/edit/{id}(id=${category.id})}"
                               class="qr-manage-btn qr-manage-btn-sm qr-manage-btn-secondary">수정</a>
                            <form th:action="@{/qr-manage/shop/admin/category/delete/{id}(id=${category.id})}" method="post" style="display: inline;">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                <button type="submit" class="qr-manage-btn qr-manage-btn-sm qr-manage-btn-danger"
                                        onclick="return confirm('이 카테고리를 삭제하시겠습니까?')">삭제</button>
                            </form>
                        </td>
                    </tr>
                </tbody>
            </table>
            <p th:if="${#lists.isEmpty(categories)}" class="qr-manage-text-center" style="color: #999; padding: 40px 0;">
                등록된 카테고리가 없습니다.
            </p>
        </div>
    </div>

    <style>
        .qr-manage-drag-handle:hover {
            background-color: #f0f0f0;
        }
        .sortable-ghost {
            opacity: 0.4;
            background-color: #c8ebfb;
        }
    </style>

    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            const tbody = document.getElementById('sortableCategories');
            if (tbody && typeof Sortable !== 'undefined') {
                new Sortable(tbody, {
                    handle: '.qr-manage-drag-handle',
                    animation: 150,
                    onEnd: function(evt) {
                        const categoryIds = Array.from(tbody.querySelectorAll('tr')).map(row => parseInt(row.dataset.id));
                        const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content') || '';

                        fetch('/qr-manage/shop/admin/category/sort', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-TOKEN': csrfToken
                            },
                            body: JSON.stringify(categoryIds)
                        });
                    }
                });
            }
        });
    </script>
</th:block>

</html>
