<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="co.grap.pack.qrgen.visitor.mapper.QrGenVisitorMapper">

    <!-- 결과 매핑 -->
    <resultMap id="QrGenVisitorResultMap" type="QrGenVisitor">
        <id property="qrGenVisitorId" column="qr_gen_visitor_id"/>
        <result property="qrGenVisitorSessionId" column="qr_gen_visitor_session_id"/>
        <result property="qrGenVisitorUserId" column="qr_gen_visitor_user_id"/>
        <result property="qrGenVisitorIpAddress" column="qr_gen_visitor_ip_address"/>
        <result property="qrGenVisitorUserAgent" column="qr_gen_visitor_user_agent"/>
        <result property="qrGenVisitorPageUrl" column="qr_gen_visitor_page_url"/>
        <result property="qrGenVisitorReferrer" column="qr_gen_visitor_referrer"/>
        <result property="qrGenVisitorBrowserName" column="qr_gen_visitor_browser_name"/>
        <result property="qrGenVisitorBrowserVersion" column="qr_gen_visitor_browser_version"/>
        <result property="qrGenVisitorOsName" column="qr_gen_visitor_os_name"/>
        <result property="qrGenVisitorOsVersion" column="qr_gen_visitor_os_version"/>
        <result property="qrGenVisitorDeviceType" column="qr_gen_visitor_device_type"/>
        <result property="qrGenVisitorScreenResolution" column="qr_gen_visitor_screen_resolution"/>
        <result property="qrGenVisitorLanguage" column="qr_gen_visitor_language"/>
        <result property="qrGenVisitorVisitedAt" column="qr_gen_visitor_visited_at"/>
        <result property="qrGenVisitorDurationSeconds" column="qr_gen_visitor_duration_seconds"/>
    </resultMap>

    <!-- 방문자 기록 추가 -->
    <insert id="insertQrGenVisitor" parameterType="QrGenVisitor" useGeneratedKeys="true" keyProperty="qrGenVisitorId">
        INSERT INTO qr_gen_visitor (
            qr_gen_visitor_session_id,
            qr_gen_visitor_user_id,
            qr_gen_visitor_ip_address,
            qr_gen_visitor_user_agent,
            qr_gen_visitor_page_url,
            qr_gen_visitor_referrer,
            qr_gen_visitor_browser_name,
            qr_gen_visitor_browser_version,
            qr_gen_visitor_os_name,
            qr_gen_visitor_os_version,
            qr_gen_visitor_device_type,
            qr_gen_visitor_screen_resolution,
            qr_gen_visitor_language,
            qr_gen_visitor_visited_at
        ) VALUES (
            #{qrGenVisitorSessionId},
            #{qrGenVisitorUserId},
            #{qrGenVisitorIpAddress},
            #{qrGenVisitorUserAgent},
            #{qrGenVisitorPageUrl},
            #{qrGenVisitorReferrer},
            #{qrGenVisitorBrowserName},
            #{qrGenVisitorBrowserVersion},
            #{qrGenVisitorOsName},
            #{qrGenVisitorOsVersion},
            #{qrGenVisitorDeviceType},
            #{qrGenVisitorScreenResolution},
            #{qrGenVisitorLanguage},
            COALESCE(#{qrGenVisitorVisitedAt}, NOW())
        )
    </insert>

    <!-- 방문자 ID로 조회 -->
    <select id="findQrGenVisitorById" resultMap="QrGenVisitorResultMap">
        SELECT * FROM qr_gen_visitor
        WHERE qr_gen_visitor_id = #{visitorId}
    </select>

    <!-- 체류시간 및 클라이언트 정보 업데이트 -->
    <update id="updateQrGenVisitorDuration">
        UPDATE qr_gen_visitor
        SET
            qr_gen_visitor_duration_seconds = #{durationSeconds}
            <if test="screenResolution != null">
                , qr_gen_visitor_screen_resolution = #{screenResolution}
            </if>
            <if test="language != null">
                , qr_gen_visitor_language = #{language}
            </if>
        WHERE qr_gen_visitor_id = #{visitorId}
    </update>

    <!-- 세션 ID로 방문자 목록 조회 -->
    <select id="findQrGenVisitorsBySessionId" resultMap="QrGenVisitorResultMap">
        SELECT * FROM qr_gen_visitor
        WHERE qr_gen_visitor_session_id = #{sessionId}
        ORDER BY qr_gen_visitor_visited_at DESC
    </select>

    <!-- 사용자 ID로 방문자 목록 조회 -->
    <select id="findQrGenVisitorsByUserId" resultMap="QrGenVisitorResultMap">
        SELECT * FROM qr_gen_visitor
        WHERE qr_gen_visitor_user_id = #{userId}
        ORDER BY qr_gen_visitor_visited_at DESC
    </select>

</mapper>
