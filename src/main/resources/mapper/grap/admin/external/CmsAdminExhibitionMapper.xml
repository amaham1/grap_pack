<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="co.grap.pack.grap.admin.external.mapper.CmsAdminExhibitionMapper">

    <!-- 공연/전시 목록 조회 (페이징) -->
    <select id="selectExhibitionList" resultType="map">
        SELECT
            id,
            original_api_id AS originalApiId,
            title,
            category_name AS categoryName,
            start_date AS startDate,
            end_date AS endDate,
            location_name AS locationName,
            source_type AS sourceType,
            writer_name AS writerName,
            is_show AS isShow,
            admin_memo AS adminMemo,
            is_confirmed AS isConfirmed,
            confirm_status AS confirmStatus,
            confirmed_by AS confirmedBy,
            confirmed_at AS confirmedAt,
            confirm_memo AS confirmMemo,
            fetched_at AS fetchedAt,
            created_at AS createdAt,
            updated_at AS updatedAt
        FROM exhibitions
        <where>
            <if test="keyword != null and keyword != ''">
                AND (title LIKE CONCAT('%', #{keyword}, '%')
                     OR location_name LIKE CONCAT('%', #{keyword}, '%')
                     OR organizer_info LIKE CONCAT('%', #{keyword}, '%'))
            </if>
        </where>
        ORDER BY created_at DESC
        LIMIT #{offset}, #{size}
    </select>

    <!-- 공연/전시 전체 개수 조회 -->
    <select id="selectExhibitionCount" resultType="int">
        SELECT COUNT(*)
        FROM exhibitions
        <where>
            <if test="keyword != null and keyword != ''">
                AND (title LIKE CONCAT('%', #{keyword}, '%')
                     OR location_name LIKE CONCAT('%', #{keyword}, '%')
                     OR organizer_info LIKE CONCAT('%', #{keyword}, '%'))
            </if>
        </where>
    </select>

    <!-- 공연/전시 상세 조회 -->
    <select id="selectExhibitionById" resultType="map">
        SELECT
            id,
            original_api_id AS originalApiId,
            title,
            category_name AS categoryName,
            cover_image_url AS coverImageUrl,
            start_date AS startDate,
            end_date AS endDate,
            time_info AS timeInfo,
            location_name AS locationName,
            organizer_info AS organizerInfo,
            tel_number AS telNumber,
            pay_info AS payInfo,
            status_info AS statusInfo,
            division_name AS divisionName,
            api_raw_data AS apiRawData,
            source_type AS sourceType,
            writer_name AS writerName,
            is_show AS isShow,
            admin_memo AS adminMemo,
            is_confirmed AS isConfirmed,
            confirm_status AS confirmStatus,
            confirmed_by AS confirmedBy,
            confirmed_at AS confirmedAt,
            confirm_memo AS confirmMemo,
            fetched_at AS fetchedAt,
            created_at AS createdAt,
            updated_at AS updatedAt
        FROM exhibitions
        WHERE id = #{id}
    </select>

    <!-- 노출 여부 업데이트 -->
    <update id="updateIsShow">
        UPDATE exhibitions
        SET is_show = #{isShow}
        WHERE id = #{id}
    </update>

    <!-- 관리자 메모 업데이트 -->
    <update id="updateAdminMemo">
        UPDATE exhibitions
        SET admin_memo = #{adminMemo}
        WHERE id = #{id}
    </update>

    <!-- 검수 처리 -->
    <update id="updateConfirmStatus">
        UPDATE exhibitions
        SET is_confirmed = CASE WHEN #{confirmStatus} = 'APPROVED' THEN TRUE ELSE FALSE END,
            confirm_status = #{confirmStatus},
            confirmed_by = #{confirmedBy},
            confirmed_at = NOW(),
            confirm_memo = #{confirmMemo}
        WHERE id = #{id}
    </update>

    <!-- 공연/전시 삭제 -->
    <delete id="deleteExhibition">
        DELETE FROM exhibitions
        WHERE id = #{id}
    </delete>

    <!-- 노출 여부 일괄 업데이트 -->
    <update id="bulkUpdateIsShow">
        UPDATE exhibitions
        SET is_show = #{isShow}
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

</mapper>
