<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="co.grap.pack.grap.admin.external.mapper.AdminGasStationMapper">

    <!-- 주유소 목록 조회 (페이징) -->
    <select id="selectGasStationList" resultType="map">
        SELECT
            gs.id,
            gs.opinet_id AS opinetId,
            gs.station_name AS stationName,
            gs.brand,
            gs.address,
            gs.phone,
            gp.gasoline_price AS gasolinePrice,
            gp.diesel_price AS dieselPrice,
            gp.price_date AS priceDate,
            gs.created_at AS createdAt,
            gs.updated_at AS updatedAt
        FROM gas_stations gs
        LEFT JOIN (
            SELECT
                opinet_id,
                gasoline_price,
                diesel_price,
                price_date,
                ROW_NUMBER() OVER (PARTITION BY opinet_id ORDER BY price_date DESC, fetched_at DESC) as rn
            FROM gas_prices
        ) gp ON gs.opinet_id = gp.opinet_id AND gp.rn = 1
        <where>
            <if test="keyword != null and keyword != ''">
                AND (gs.station_name LIKE CONCAT('%', #{keyword}, '%')
                     OR gs.brand LIKE CONCAT('%', #{keyword}, '%')
                     OR gs.address LIKE CONCAT('%', #{keyword}, '%'))
            </if>
        </where>
        ORDER BY gs.station_name ASC
        LIMIT #{offset}, #{size}
    </select>

    <!-- 주유소 전체 개수 조회 -->
    <select id="selectGasStationCount" resultType="int">
        SELECT COUNT(*)
        FROM gas_stations gs
        <where>
            <if test="keyword != null and keyword != ''">
                AND (gs.station_name LIKE CONCAT('%', #{keyword}, '%')
                     OR gs.brand LIKE CONCAT('%', #{keyword}, '%')
                     OR gs.address LIKE CONCAT('%', #{keyword}, '%'))
            </if>
        </where>
    </select>

    <!-- 주유소 상세 조회 -->
    <select id="selectGasStationById" resultType="map">
        SELECT
            gs.id,
            gs.opinet_id AS opinetId,
            gs.station_name AS stationName,
            gs.brand,
            gs.address,
            gs.latitude,
            gs.longitude,
            gs.phone,
            gs.api_raw_data AS apiRawData,
            gs.created_at AS createdAt,
            gs.updated_at AS updatedAt
        FROM gas_stations gs
        WHERE gs.id = #{id}
    </select>

    <!-- 주유소 삭제 (CASCADE로 가격 정보도 함께 삭제됨) -->
    <delete id="deleteGasStation">
        DELETE FROM gas_stations
        WHERE id = #{id}
    </delete>

</mapper>
