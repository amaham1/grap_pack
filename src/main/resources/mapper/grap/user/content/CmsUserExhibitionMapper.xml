<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="co.grap.pack.grap.user.content.mapper.CmsUserExhibitionMapper">

    <!-- 노출 설정된 공연/전시 목록 조회 (탭별 필터링) -->
    <select id="selectVisibleExhibitionList" resultType="map">
        SELECT
            id,
            original_api_id AS originalApiId,
            title,
            category_name AS categoryName,
            cover_image_url AS coverImageUrl,
            start_date AS startDate,
            end_date AS endDate,
            time_info AS timeInfo,
            location_name AS locationName,
            organizer_info AS organizerInfo,
            tel_number AS telNumber,
            pay_info AS payInfo,
            status_info AS statusInfo,
            division_name AS divisionName,
            fetched_at AS fetchedAt,
            created_at AS createdAt,
            updated_at AS updatedAt
        FROM exhibitions
        WHERE is_show = TRUE
        <if test="keyword != null and keyword != ''">
            AND (title LIKE CONCAT('%', #{keyword}, '%')
                 OR location_name LIKE CONCAT('%', #{keyword}, '%')
                 OR organizer_info LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        <!-- 탭별 필터링 -->
        <choose>
            <!-- 진행 중인 공연: 시작일 <= 오늘 <= 종료일 -->
            <when test="tab == 'ongoing'">
                AND start_date &lt;= NOW()
                AND end_date &gt;= NOW()
            </when>
            <!-- 다가올 공연: 시작일 > 오늘 -->
            <when test="tab == 'upcoming'">
                AND start_date &gt; NOW()
            </when>
            <!-- 끝난 공연: 종료일 < 오늘 -->
            <when test="tab == 'ended'">
                AND end_date &lt; NOW()
            </when>
        </choose>
        <!-- 탭별 정렬 -->
        <choose>
            <when test="tab == 'ongoing'">
                ORDER BY end_date ASC, start_date ASC
            </when>
            <when test="tab == 'upcoming'">
                ORDER BY start_date ASC
            </when>
            <when test="tab == 'ended'">
                ORDER BY end_date DESC
            </when>
            <otherwise>
                ORDER BY start_date DESC, created_at DESC
            </otherwise>
        </choose>
        LIMIT #{offset}, #{size}
    </select>

    <!-- 노출 설정된 공연/전시 전체 개수 조회 (탭별 필터링) -->
    <select id="selectVisibleExhibitionCount" resultType="int">
        SELECT COUNT(*)
        FROM exhibitions
        WHERE is_show = TRUE
        <if test="keyword != null and keyword != ''">
            AND (title LIKE CONCAT('%', #{keyword}, '%')
                 OR location_name LIKE CONCAT('%', #{keyword}, '%')
                 OR organizer_info LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        <!-- 탭별 필터링 -->
        <choose>
            <when test="tab == 'ongoing'">
                AND start_date &lt;= NOW()
                AND end_date &gt;= NOW()
            </when>
            <when test="tab == 'upcoming'">
                AND start_date &gt; NOW()
            </when>
            <when test="tab == 'ended'">
                AND end_date &lt; NOW()
            </when>
        </choose>
    </select>

    <!-- 공연/전시 상세 조회 (노출 설정된 것만) -->
    <select id="selectVisibleExhibitionById" resultType="map">
        SELECT
            id,
            original_api_id AS originalApiId,
            title,
            category_name AS categoryName,
            cover_image_url AS coverImageUrl,
            start_date AS startDate,
            end_date AS endDate,
            time_info AS timeInfo,
            location_name AS locationName,
            organizer_info AS organizerInfo,
            tel_number AS telNumber,
            pay_info AS payInfo,
            status_info AS statusInfo,
            division_name AS divisionName,
            api_raw_data AS apiRawData,
            fetched_at AS fetchedAt,
            created_at AS createdAt,
            updated_at AS updatedAt
        FROM exhibitions
        WHERE id = #{id}
          AND is_show = TRUE
    </select>

    <!-- 사용자 공연/전시 등록 요청 -->
    <insert id="insertExhibitionRequest" parameterType="co.grap.pack.grap.user.content.model.CmsUserExhibitionRequest">
        INSERT INTO exhibitions (
            original_api_id,
            title,
            category_name,
            start_date,
            end_date,
            time_info,
            location_name,
            organizer_info,
            tel_number,
            pay_info,
            source_type,
            writer_name,
            is_show,
            is_confirmed,
            confirm_status,
            fetched_at,
            created_at
        ) VALUES (
            CONCAT('USER_', UUID()),
            #{title},
            #{categoryName},
            #{startDate},
            #{endDate},
            #{timeInfo},
            #{locationName},
            #{organizerInfo},
            #{telNumber},
            #{payInfo},
            'USER',
            #{writerName},
            FALSE,
            FALSE,
            'PENDING',
            NOW(),
            NOW()
        )
    </insert>

    <!-- 마지막 INSERT ID 조회 -->
    <select id="selectLastInsertId" resultType="long">
        SELECT LAST_INSERT_ID()
    </select>

</mapper>
