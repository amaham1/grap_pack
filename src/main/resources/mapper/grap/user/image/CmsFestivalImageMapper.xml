<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="co.grap.pack.grap.user.image.mapper.CmsFestivalImageMapper">

    <!-- 결과 매핑 -->
    <resultMap id="festivalImageResultMap" type="co.grap.pack.grap.user.image.model.CmsFestivalImage">
        <id property="imageId" column="image_id"/>
        <result property="festivalId" column="festival_id"/>
        <result property="originalName" column="original_name"/>
        <result property="savedName" column="saved_name"/>
        <result property="filePath" column="file_path"/>
        <result property="fileSize" column="file_size"/>
        <result property="isThumbnail" column="is_thumbnail"/>
        <result property="displayOrder" column="display_order"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <!-- 이미지 등록 -->
    <insert id="insertImage" parameterType="co.grap.pack.grap.user.image.model.CmsFestivalImage" useGeneratedKeys="true" keyProperty="imageId">
        INSERT INTO festivals_image (
            festival_id, original_name, saved_name, file_path,
            file_size, is_thumbnail, display_order, created_at
        ) VALUES (
            #{festivalId}, #{originalName}, #{savedName}, #{filePath},
            #{fileSize}, #{isThumbnail}, #{displayOrder}, NOW()
        )
    </insert>

    <!-- 축제/행사별 이미지 목록 조회 -->
    <select id="selectImagesByFestivalId" parameterType="long" resultMap="festivalImageResultMap">
        SELECT * FROM festivals_image
        WHERE festival_id = #{festivalId}
        ORDER BY is_thumbnail DESC, display_order ASC, created_at ASC
    </select>

    <!-- 이미지 단건 조회 -->
    <select id="selectImageById" parameterType="long" resultMap="festivalImageResultMap">
        SELECT * FROM festivals_image
        WHERE image_id = #{imageId}
    </select>

    <!-- 썸네일 이미지 조회 -->
    <select id="selectThumbnailByFestivalId" parameterType="long" resultMap="festivalImageResultMap">
        SELECT * FROM festivals_image
        WHERE festival_id = #{festivalId} AND is_thumbnail = TRUE
        LIMIT 1
    </select>

    <!-- 썸네일 설정 -->
    <update id="updateThumbnail">
        UPDATE festivals_image
        SET is_thumbnail = CASE
            WHEN image_id = #{imageId} THEN TRUE
            ELSE FALSE
        END
        WHERE festival_id = #{festivalId}
    </update>

    <!-- 썸네일 해제 -->
    <update id="clearThumbnail" parameterType="long">
        UPDATE festivals_image
        SET is_thumbnail = FALSE
        WHERE festival_id = #{festivalId}
    </update>

    <!-- 이미지 삭제 -->
    <delete id="deleteImage" parameterType="long">
        DELETE FROM festivals_image
        WHERE image_id = #{imageId}
    </delete>

    <!-- 축제/행사별 이미지 전체 삭제 -->
    <delete id="deleteImagesByFestivalId" parameterType="long">
        DELETE FROM festivals_image
        WHERE festival_id = #{festivalId}
    </delete>

    <!-- 이미지 개수 조회 -->
    <select id="selectImageCountByFestivalId" parameterType="long" resultType="int">
        SELECT COUNT(*) FROM festivals_image
        WHERE festival_id = #{festivalId}
    </select>

</mapper>
