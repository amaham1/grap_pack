<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.cms.external.api.mapper.FestivalMapper">

    <!-- Result Map -->
    <resultMap id="festivalResultMap" type="com.example.cms.external.api.model.Festival">
        <id property="id" column="id"/>
        <result property="originalApiId" column="original_api_id"/>
        <result property="title" column="title"/>
        <result property="contentHtml" column="content_html"/>
        <result property="sourceUrl" column="source_url"/>
        <result property="writerName" column="writer_name"/>
        <result property="writtenDate" column="written_date"/>
        <result property="filesInfo" column="files_info"/>
        <result property="apiRawData" column="api_raw_data"/>
        <result property="isShow" column="is_show"/>
        <result property="adminMemo" column="admin_memo"/>
        <result property="fetchedAt" column="fetched_at"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!-- Insert -->
    <insert id="insert" parameterType="com.example.cms.external.api.model.Festival" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO festivals (
            original_api_id, title, content_html, source_url, writer_name,
            written_date, files_info, api_raw_data, is_show, admin_memo, fetched_at
        ) VALUES (
            #{originalApiId}, #{title}, #{contentHtml}, #{sourceUrl}, #{writerName},
            #{writtenDate}, #{filesInfo}, #{apiRawData}, #{isShow}, #{adminMemo}, #{fetchedAt}
        )
    </insert>

    <!-- Update -->
    <update id="update" parameterType="com.example.cms.external.api.model.Festival">
        UPDATE festivals
        SET title = #{title},
            content_html = #{contentHtml},
            source_url = #{sourceUrl},
            writer_name = #{writerName},
            written_date = #{writtenDate},
            files_info = #{filesInfo},
            api_raw_data = #{apiRawData},
            fetched_at = #{fetchedAt},
            updated_at = NOW()
        WHERE original_api_id = #{originalApiId}
    </update>

    <!-- Upsert (INSERT ... ON DUPLICATE KEY UPDATE) -->
    <insert id="upsert" parameterType="com.example.cms.external.api.model.Festival">
        INSERT INTO festivals (
            original_api_id, title, content_html, source_url, writer_name,
            written_date, files_info, api_raw_data, is_show, admin_memo, fetched_at
        ) VALUES (
            #{originalApiId}, #{title}, #{contentHtml}, #{sourceUrl}, #{writerName},
            #{writtenDate}, #{filesInfo}, #{apiRawData}, #{isShow}, #{adminMemo}, #{fetchedAt}
        )
        ON DUPLICATE KEY UPDATE
            title = VALUES(title),
            content_html = VALUES(content_html),
            source_url = VALUES(source_url),
            writer_name = VALUES(writer_name),
            written_date = VALUES(written_date),
            files_info = VALUES(files_info),
            api_raw_data = VALUES(api_raw_data),
            fetched_at = VALUES(fetched_at),
            updated_at = NOW()
    </insert>

    <!-- Select by original_api_id -->
    <select id="findByOriginalApiId" parameterType="string" resultMap="festivalResultMap">
        SELECT * FROM festivals WHERE original_api_id = #{originalApiId}
    </select>

    <!-- Select all -->
    <select id="findAll" resultMap="festivalResultMap">
        SELECT * FROM festivals ORDER BY written_date DESC
    </select>

    <!-- Select all visible -->
    <select id="findAllVisible" resultMap="festivalResultMap">
        SELECT * FROM festivals WHERE is_show = TRUE ORDER BY written_date DESC
    </select>

    <!-- Check exists -->
    <select id="existsByOriginalApiId" parameterType="string" resultType="boolean">
        SELECT COUNT(*) > 0 FROM festivals WHERE original_api_id = #{originalApiId}
    </select>

</mapper>
