<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.cms.external.api.mapper.GasPriceMapper">

    <!-- Result Map -->
    <resultMap id="gasPriceResultMap" type="com.example.cms.external.api.model.GasPrice">
        <id property="id" column="id"/>
        <result property="opinetId" column="opinet_id"/>
        <result property="gasolinePrice" column="gasoline_price"/>
        <result property="premiumGasolinePrice" column="premium_gasoline_price"/>
        <result property="dieselPrice" column="diesel_price"/>
        <result property="lpgPrice" column="lpg_price"/>
        <result property="priceDate" column="price_date"/>
        <result property="apiRawData" column="api_raw_data"/>
        <result property="fetchedAt" column="fetched_at"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!-- Upsert -->
    <insert id="upsert" parameterType="com.example.cms.external.api.model.GasPrice">
        INSERT INTO gas_prices (
            opinet_id, gasoline_price, premium_gasoline_price, diesel_price, lpg_price,
            price_date, api_raw_data, fetched_at
        ) VALUES (
            #{opinetId}, #{gasolinePrice}, #{premiumGasolinePrice}, #{dieselPrice}, #{lpgPrice},
            #{priceDate}, #{apiRawData}, #{fetchedAt}
        )
        ON DUPLICATE KEY UPDATE
            gasoline_price = VALUES(gasoline_price),
            premium_gasoline_price = VALUES(premium_gasoline_price),
            diesel_price = VALUES(diesel_price),
            lpg_price = VALUES(lpg_price),
            api_raw_data = VALUES(api_raw_data),
            fetched_at = VALUES(fetched_at),
            updated_at = NOW()
    </insert>

    <!-- Select by opinet_id and price_date -->
    <select id="findByOpinetIdAndDate" resultMap="gasPriceResultMap">
        SELECT * FROM gas_prices
        WHERE opinet_id = #{opinetId} AND price_date = #{priceDate}
    </select>

    <!-- Select by opinet_id -->
    <select id="findByOpinetId" parameterType="string" resultMap="gasPriceResultMap">
        SELECT * FROM gas_prices
        WHERE opinet_id = #{opinetId}
        ORDER BY price_date DESC
    </select>

    <!-- Select by date -->
    <select id="findByDate" parameterType="java.time.LocalDate" resultMap="gasPriceResultMap">
        SELECT * FROM gas_prices
        WHERE price_date = #{priceDate}
        ORDER BY opinet_id
    </select>

    <!-- Select latest prices -->
    <select id="findLatest" resultMap="gasPriceResultMap">
        SELECT gp.*
        FROM gas_prices gp
        INNER JOIN (
            SELECT opinet_id, MAX(price_date) as max_date
            FROM gas_prices
            GROUP BY opinet_id
        ) latest ON gp.opinet_id = latest.opinet_id AND gp.price_date = latest.max_date
        ORDER BY gp.opinet_id
    </select>

</mapper>
