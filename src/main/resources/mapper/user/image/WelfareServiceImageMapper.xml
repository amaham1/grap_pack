<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.cms.user.image.mapper.WelfareServiceImageMapper">

    <!-- 결과 매핑 -->
    <resultMap id="welfareServiceImageResultMap" type="com.example.cms.user.image.model.WelfareServiceImage">
        <id property="imageId" column="image_id"/>
        <result property="welfareServiceId" column="welfare_service_id"/>
        <result property="originalName" column="original_name"/>
        <result property="savedName" column="saved_name"/>
        <result property="filePath" column="file_path"/>
        <result property="fileSize" column="file_size"/>
        <result property="isThumbnail" column="is_thumbnail"/>
        <result property="displayOrder" column="display_order"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <!-- 이미지 등록 -->
    <insert id="insertImage" parameterType="com.example.cms.user.image.model.WelfareServiceImage" useGeneratedKeys="true" keyProperty="imageId">
        INSERT INTO welfare_services_image (
            welfare_service_id, original_name, saved_name, file_path,
            file_size, is_thumbnail, display_order, created_at
        ) VALUES (
            #{welfareServiceId}, #{originalName}, #{savedName}, #{filePath},
            #{fileSize}, #{isThumbnail}, #{displayOrder}, NOW()
        )
    </insert>

    <!-- 복지서비스별 이미지 목록 조회 -->
    <select id="selectImagesByWelfareServiceId" parameterType="long" resultMap="welfareServiceImageResultMap">
        SELECT * FROM welfare_services_image
        WHERE welfare_service_id = #{welfareServiceId}
        ORDER BY is_thumbnail DESC, display_order ASC, created_at ASC
    </select>

    <!-- 이미지 단건 조회 -->
    <select id="selectImageById" parameterType="long" resultMap="welfareServiceImageResultMap">
        SELECT * FROM welfare_services_image
        WHERE image_id = #{imageId}
    </select>

    <!-- 썸네일 이미지 조회 -->
    <select id="selectThumbnailByWelfareServiceId" parameterType="long" resultMap="welfareServiceImageResultMap">
        SELECT * FROM welfare_services_image
        WHERE welfare_service_id = #{welfareServiceId} AND is_thumbnail = TRUE
        LIMIT 1
    </select>

    <!-- 썸네일 설정 -->
    <update id="updateThumbnail">
        UPDATE welfare_services_image
        SET is_thumbnail = CASE
            WHEN image_id = #{imageId} THEN TRUE
            ELSE FALSE
        END
        WHERE welfare_service_id = #{welfareServiceId}
    </update>

    <!-- 썸네일 해제 -->
    <update id="clearThumbnail" parameterType="long">
        UPDATE welfare_services_image
        SET is_thumbnail = FALSE
        WHERE welfare_service_id = #{welfareServiceId}
    </update>

    <!-- 이미지 삭제 -->
    <delete id="deleteImage" parameterType="long">
        DELETE FROM welfare_services_image
        WHERE image_id = #{imageId}
    </delete>

    <!-- 복지서비스별 이미지 전체 삭제 -->
    <delete id="deleteImagesByWelfareServiceId" parameterType="long">
        DELETE FROM welfare_services_image
        WHERE welfare_service_id = #{welfareServiceId}
    </delete>

    <!-- 이미지 개수 조회 -->
    <select id="selectImageCountByWelfareServiceId" parameterType="long" resultType="int">
        SELECT COUNT(*) FROM welfare_services_image
        WHERE welfare_service_id = #{welfareServiceId}
    </select>

</mapper>
