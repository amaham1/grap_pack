<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="co.grap.pack.user.content.mapper.UserGasStationMapper">

    <!-- 주유소 및 최신 가격 목록 조회 -->
    <select id="selectGasStationListWithLatestPrice" resultType="map">
        SELECT
            gs.id,
            gs.opinet_id AS opinetId,
            gs.station_name AS stationName,
            gs.brand,
            gs.address,
            gs.latitude,
            gs.longitude,
            gs.phone,
            gp.gasoline_price AS gasolinePrice,
            gp.premium_gasoline_price AS premiumGasolinePrice,
            gp.diesel_price AS dieselPrice,
            gp.lpg_price AS lpgPrice,
            gp.price_date AS priceDate,
            gp.fetched_at AS priceFetchedAt,
            gs.created_at AS createdAt,
            gs.updated_at AS updatedAt
        FROM gas_stations gs
        LEFT JOIN (
            SELECT
                opinet_id,
                gasoline_price,
                premium_gasoline_price,
                diesel_price,
                lpg_price,
                price_date,
                fetched_at,
                ROW_NUMBER() OVER (PARTITION BY opinet_id ORDER BY price_date DESC, fetched_at DESC) as rn
            FROM gas_prices
        ) gp ON gs.opinet_id = gp.opinet_id AND gp.rn = 1
        <where>
            <if test="keyword != null and keyword != ''">
                AND (gs.station_name LIKE CONCAT('%', #{keyword}, '%')
                     OR gs.brand LIKE CONCAT('%', #{keyword}, '%')
                     OR gs.address LIKE CONCAT('%', #{keyword}, '%'))
            </if>
        </where>
        ORDER BY gs.station_name ASC
        LIMIT #{offset}, #{size}
    </select>

    <!-- 주유소 전체 개수 조회 -->
    <select id="selectGasStationCount" resultType="int">
        SELECT COUNT(*)
        FROM gas_stations gs
        <where>
            <if test="keyword != null and keyword != ''">
                AND (gs.station_name LIKE CONCAT('%', #{keyword}, '%')
                     OR gs.brand LIKE CONCAT('%', #{keyword}, '%')
                     OR gs.address LIKE CONCAT('%', #{keyword}, '%'))
            </if>
        </where>
    </select>

    <!-- 주유소 및 최신 가격 상세 조회 -->
    <select id="selectGasStationByIdWithLatestPrice" resultType="map">
        SELECT
            gs.id,
            gs.opinet_id AS opinetId,
            gs.station_name AS stationName,
            gs.brand,
            gs.address,
            gs.latitude,
            gs.longitude,
            gs.phone,
            gs.api_raw_data AS stationRawData,
            gp.gasoline_price AS gasolinePrice,
            gp.premium_gasoline_price AS premiumGasolinePrice,
            gp.diesel_price AS dieselPrice,
            gp.lpg_price AS lpgPrice,
            gp.price_date AS priceDate,
            gp.fetched_at AS priceFetchedAt,
            gs.created_at AS createdAt,
            gs.updated_at AS updatedAt
        FROM gas_stations gs
        LEFT JOIN (
            SELECT
                opinet_id,
                gasoline_price,
                premium_gasoline_price,
                diesel_price,
                lpg_price,
                price_date,
                fetched_at,
                ROW_NUMBER() OVER (PARTITION BY opinet_id ORDER BY price_date DESC, fetched_at DESC) as rn
            FROM gas_prices
        ) gp ON gs.opinet_id = gp.opinet_id AND gp.rn = 1
        WHERE gs.id = #{id}
    </select>

    <!-- 특정 주유소의 가격 이력 조회 (최근 30일) -->
    <select id="selectGasPriceHistory" resultType="map">
        SELECT
            opinet_id AS opinetId,
            gasoline_price AS gasolinePrice,
            premium_gasoline_price AS premiumGasolinePrice,
            diesel_price AS dieselPrice,
            lpg_price AS lpgPrice,
            price_date AS priceDate,
            fetched_at AS fetchedAt
        FROM gas_prices
        WHERE opinet_id = #{opinetId}
        ORDER BY price_date DESC, fetched_at DESC
        LIMIT #{limit}
    </select>

</mapper>
