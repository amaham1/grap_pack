<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.cms.user.content.mapper.UserFestivalMapper">

    <!-- 노출 설정된 축제/행사 목록 조회 -->
    <select id="selectVisibleFestivalList" resultType="map">
        SELECT
            id,
            original_api_id AS originalApiId,
            title,
            content_html AS contentHtml,
            source_url AS sourceUrl,
            writer_name AS writerName,
            written_date AS writtenDate,
            files_info AS filesInfo,
            fetched_at AS fetchedAt,
            created_at AS createdAt,
            updated_at AS updatedAt
        FROM festivals
        WHERE is_show = TRUE
        <if test="keyword != null and keyword != ''">
            AND (title LIKE CONCAT('%', #{keyword}, '%')
                 OR content_html LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        ORDER BY written_date DESC, created_at DESC
        LIMIT #{offset}, #{size}
    </select>

    <!-- 노출 설정된 축제/행사 전체 개수 조회 -->
    <select id="selectVisibleFestivalCount" resultType="int">
        SELECT COUNT(*)
        FROM festivals
        WHERE is_show = TRUE
        <if test="keyword != null and keyword != ''">
            AND (title LIKE CONCAT('%', #{keyword}, '%')
                 OR content_html LIKE CONCAT('%', #{keyword}, '%'))
        </if>
    </select>

    <!-- 축제/행사 상세 조회 (노출 설정된 것만) -->
    <select id="selectVisibleFestivalById" resultType="map">
        SELECT
            id,
            original_api_id AS originalApiId,
            title,
            content_html AS contentHtml,
            source_url AS sourceUrl,
            writer_name AS writerName,
            written_date AS writtenDate,
            files_info AS filesInfo,
            api_raw_data AS apiRawData,
            fetched_at AS fetchedAt,
            created_at AS createdAt,
            updated_at AS updatedAt
        FROM festivals
        WHERE id = #{id}
          AND is_show = TRUE
    </select>

</mapper>
